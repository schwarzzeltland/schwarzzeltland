{% extends "base.html" %}
{% block content %}
    <div class="card shadow-sm rounded-3 mb-3">
        <div class="card-header bg-light fw-bold">
            Checkliste
        </div>
        <div class="card-body p-0">
            <div class="checklist-wrapper" style="overflow-x: auto;">
                <ul class="list-group list-group-flush d-flex flex-column" style="min-width: 600px;" id="checklist">
                    {% for item in items %}
                        <li class="list-group-item d-flex justify-content-between align-items-center"
                            id="item-{{ item.id }}">
                            <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-2 w-100">
                                <div class="form-check flex-grow-1">
                                    <input class="form-check-input toggle-done me-2" type="checkbox"
                                           data-id="{{ item.id }}"
                                           data-url="{% url 'toggle_checklist_item' item.id %}"
                                           {% if item.done %}checked{% endif %}>
                                    <label class="form-check-label fw-semibold">{{ item.title }}</label>
                                </div>
                                <div>
                                    <label class="text-muted small me-1">Fällig:</label>
                                    <input type="datetime-local" class="form-control form-control-sm inline-due-date"
                                           data-id="{{ item.id }}"
                                           value="{{ item.due_date|date:'Y-m-d\\TH:i' }}">
                                </div>
                            </div>
                            <button class="btn btn-outline-danger btn-sm ms-2 delete-btn"
                                    data-id="{{ item.id }}"
                                    data-url="{% url 'delete_checklist_item' item.id %}">
                                ✖
                            </button>
                        </li>
                    {% empty %}
                        <li class="list-group-item text-muted" id="no-items-placeholder">Noch keine Punkte.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <div class="card-footer bg-light">
            <div style="overflow-x: auto;">
                <form id="add-item-form" class="d-flex gap-2 align-items-end flex-nowrap"
                      style="min-width: max-content;">
                    {% csrf_token %}
                    <div style="flex: 2; min-width: 200px;">
                        <input type="text" name="title" placeholder="Neuen Punkt hinzufügen"
                               class="form-control" required>
                    </div>
                    <div style="flex: 2; min-width: 200px;">
                        <input type="datetime-local" name="due_date" class="form-control">
                    </div>
                    <button type="submit" class="btn btn-success" style="min-width: 120px;">Hinzufügen</button>
                </form>
            </div>
        </div>
    </div>

    <div class="mb-3">
        <button type="button" class="btn btn-secondary" onclick="history.back()">Zurück</button>
    </div>
    <script>
        function getCookie(name) {
            const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
            return m ? m.pop() : '';
        }

        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("add-item-form");
            const checklist = document.getElementById("checklist");
            const csrf = getCookie("csrftoken");

            // Punkt hinzufügen
            form.addEventListener("submit", function (e) {
                e.preventDefault();
                const formData = new FormData(form);
                fetch("{% url 'add_organization_material_checklist_item' %}", {
                    method: "POST",
                    headers: {"X-CSRFToken": csrf},
                    body: formData
                }).then(res => res.json()).then(data => {
                    if (data.success) {
                        const item = data.item;
                        // ✅ Platzhalter entfernen, falls vorhanden
                        const placeholder = document.getElementById("no-items-placeholder");
                        if (placeholder) {
                            placeholder.remove();
                        }
                        const li = document.createElement("li");
                        li.className = "list-group-item d-flex justify-content-between align-items-center";
                        li.id = "item-" + item.id;
                        li.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center w-100">
                        <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-2 flex-grow-1">
                        <div class="form-check flex-grow-1">
                        <input class="form-check-input toggle-done me-2" type="checkbox" data-id="${item.id}" ${item.done ? "checked" : ""}>
                        <label class="form-check-label fw-semibold mb-0">${item.title}</label>
                        </div>
                        <div class="d-flex flex-column">
                        <label class="text-muted small mb-0">Fällig:</label>
                        <input type="datetime-local" class="form-control form-control-sm inline-due-date"
                        data-id="${item.id}"
                        value="${item.due_date ? item.due_date.replace(' ', 'T').slice(0, 16) : ''}">
                        </div>
                        </div>
                        <button class="btn btn-outline-danger btn-sm ms-2 delete-btn"
                        data-id="${item.id}" data-url="${item.delete_url}">✖</button>
                        </div>
                        `;
                        checklist.appendChild(li);
                        attachHandlers(li);
                        form.reset();
                    }
                });
            });

            function attachHandlers(parent) {
                // Toggle Done
                parent.querySelectorAll(".toggle-done").forEach(input => {
                    input.onclick = function () {
                        const id = this.dataset.id;
                        const url = this.dataset.url;
                        fetch(url, {
                            method: "POST",
                            headers: {"X-CSRFToken": csrf}
                        })
                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    const li = document.getElementById("item-" + id);
                                    li.classList.toggle("done", data.done);
                                }
                            });
                    }
                });
                // Delete
                parent.querySelectorAll(".delete-btn").forEach(btn => {
                    btn.onclick = function () {
                        const id = this.dataset.id;
                        const url = this.dataset.url;
                        fetch(url, {method: "POST", headers: {"X-CSRFToken": csrf}})
                            .then(res => res.json()).then(data => {
                            if (data.success) {
                                const li = document.getElementById("item-" + id);
                                li.remove();
                            }
                        });
                    }
                });
            }

            document.querySelectorAll(".inline-due-date").forEach(input => {
                input.onchange = function () {
                    const id = this.dataset.id;
                    const value = this.value;
                    const csrftoken = getCookie('csrftoken');
                    const currentInput = this;

                    fetch("{% url 'update_checklist_due_date' %}", {
                        method: "POST",
                        headers: {"Content-Type": "application/json", "X-CSRFToken": csrftoken},
                        body: JSON.stringify({id: id, value: value})
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (!data.success) {
                                currentInput.classList.add("is-invalid");
                                alert("Fehler beim Speichern");
                            } else {
                                currentInput.classList.remove("is-invalid");
                                currentInput.value = data.due_date; // ggf. formatiertes Datum zurücksetzen
                            }
                        });
                }
            });
            // Initiale Items
            checklist.querySelectorAll("li").forEach(li => attachHandlers(li));
        });
    </script>

{% endblock %}

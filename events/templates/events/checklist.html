{% extends "base.html" %}
{% block content %}
    <ul class="list-group list-group-flush" id="checklist">
        {% for item in items %}
            <li class="list-group-item d-flex justify-content-between align-items-center" id="item-{{ item.id }}">
                <div class="form-check">
                    <input class="form-check-input toggle-done" type="checkbox" data-id="{{ item.id }}"
                           data-url="{% url 'toggle_checklist_item' item.id %}" {% if item.done %}checked{% endif %}>
                    <label class="form-check-label">{{ item.title }} - Fällig am</label>
                    <input type="datetime-local" class="inline-due-date" data-id="{{ item.id }}"
                           value="{{ item.due_date|date:'Y-m-d\\TH:i' }}">
                </div>
                <button class="btn btn-danger btn-sm delete-btn" data-id="{{ item.id }}"
                        data-url="{% url 'delete_checklist_item' item.id %}">✖
                </button>
            </li>
        {% empty %}
            <li class="list-group-item">Noch keine Punkte.</li>
        {% endfor %}
    </ul>

    <div class="card-footer">
        <form id="add-item-form" class="d-flex gap-2">
            {% csrf_token %}
            <input type="text" name="title" placeholder="Neuen Punkt hinzufügen" class="form-control" required>
            <input type="datetime-local" name="due_date" class="form-control">
            <button type="submit" class="btn btn-success">Hinzufügen</button>
        </form>
    </div>
    <script>
        function getCookie(name) {
            const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
            return m ? m.pop() : '';
        }

        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("add-item-form");
            const checklist = document.getElementById("checklist");
            const csrf = getCookie("csrftoken");

            // Punkt hinzufügen
            form.addEventListener("submit", function (e) {
                e.preventDefault();
                const formData = new FormData(form);
                fetch("{% url 'add_checklist_item' trip.id %}", {
                    method: "POST",
                    headers: {"X-CSRFToken": csrf},
                    body: formData
                }).then(res => res.json()).then(data => {
                    if (data.success) {
                        const item = data.item;
                        const li = document.createElement("li");
                        li.className = "list-group-item d-flex justify-content-between align-items-center";
                        li.id = "item-" + item.id;
                        li.innerHTML = `
                    <div class="form-check d-flex align-items-center gap-2">
                    <input class="form-check-input toggle-done" type="checkbox" data-id="${item.id}" ${item.done ? "checked" : ""}>
                    <label class="form-check-label mb-0">${item.title}  - Fällig am</label>
                    <input type="datetime-local" class="inline-due-date ms-2" data-id="${item.id}" value="${item.due_date ? item.due_date.replace(' ', 'T').slice(0,16) : ''}">
                </div>
                    <button class="btn btn-danger btn-sm delete-btn" data-id="${item.id}" data-url="${item.delete_url}">✖</button>
                `;
                        checklist.appendChild(li);
                        attachHandlers(li);
                        form.reset();
                    }
                });
            });

            function attachHandlers(parent) {
                // Toggle Done
                parent.querySelectorAll(".toggle-done").forEach(input => {
                    input.onclick = function () {
                        const id = this.dataset.id;
                        const url = this.dataset.url;
                        fetch(url, {
                            method: "POST",
                            headers: {"X-CSRFToken": csrf}
                        })
                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    const li = document.getElementById("item-" + id);
                                    li.classList.toggle("done", data.done);
                                }
                            });
                    }
                });
                // Delete
                parent.querySelectorAll(".delete-btn").forEach(btn => {
                    btn.onclick = function () {
                        const id = this.dataset.id;
                        const url = this.dataset.url;
                        fetch(url, {method: "POST", headers: {"X-CSRFToken": csrf}})
                            .then(res => res.json()).then(data => {
                            if (data.success) {
                                const li = document.getElementById("item-" + id);
                                li.remove();
                            }
                        });
                    }
                });
            }

            document.querySelectorAll(".inline-due-date").forEach(input => {
                input.onchange = function () {
                    const id = this.dataset.id;
                    const value = this.value;
                    const csrftoken = getCookie('csrftoken');
                    const currentInput = this;

                    fetch("{% url 'update_checklist_due_date' %}", {
                        method: "POST",
                        headers: {"Content-Type": "application/json", "X-CSRFToken": csrftoken},
                        body: JSON.stringify({id: id, value: value})
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (!data.success) {
                                currentInput.classList.add("is-invalid");
                                alert("Fehler beim Speichern");
                            } else {
                                currentInput.classList.remove("is-invalid");
                                currentInput.value = data.due_date; // ggf. formatiertes Datum zurücksetzen
                            }
                        });
                }
            });
            // Initiale Items
            checklist.querySelectorAll("li").forEach(li => attachHandlers(li));
        });
    </script>


{% endblock %}

{% extends "base.html" %}
{% load bootstrap5 %}

{% block content %}
    <div id="messages"></div>
    <form method="get" action="" class="mb-3">
        <div class="input-group">
            <!-- Suchfeld -->
            <input type="text" class="form-control"
                   name="search"
                   value="{{ search_query|default:'' }}"
                   placeholder="Suchen nach Artikel">

            <!-- Dropdown Warengruppe -->
            <select class="form-select" name="product_group">
                <option value="">Alle Warengruppen</option>
                {% for value, label in product_groups %}
                    <option value="{{ value }}"
                            {% if value|stringformat:"s" == selected_product_group %}selected{% endif %}>
                        {{ label }}
                    </option>
                {% endfor %}
            </select>

            <!-- Button -->
            <button class="btn btn-outline-secondary" type="submit">Suchen</button>
        </div>
    </form>
    <div class="table-responsive mb-3">
        <table class="table" id="shoppinglist-table">
            <thead>
            <tr>
                <th>Artikel</th>
                <th>Menge</th>
                <th>Einheit</th>
                <th>Warengruppe</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            {% for item in shoppinglist %}
                <tr id="item-{{ item.pk }}">
                    <td>{{ item.name }}</td>
                    <td>
                        <input type="number" step="0.01" class="form-control form-control-sm inline-edit"
                               data-id="{{ item.pk }}" data-field="amount"
                               value="{{ item.amount_str }}">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm inline-edit"
                               data-id="{{ item.pk }}" data-field="unit"
                               value="{{ item.unit }}">
                    </td>
                    <td>
                        <select class="form-select form-select-sm inline-edit"
                                data-id="{{ item.pk }}"
                                data-field="product_group">
                            <option value="">---------</option>
                            {% for value, label in item.GROUPS %}
                                <option value="{{ value }}"
                                        {% if item.product_group == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td class="text-end">
                        <button class="btn btn-success btn-sm delete-item"
                                data-id="{{ item.pk }}"
                                data-url="{% url 'delete_shoppinglist_item' item.pk %}">
                            ✔
                        </button>
                    </td>
                </tr>
            {% empty %}
                <tr id="no-items-row">
                    <td colspan="4" class="text-center text-muted">Keine Artikel in der Einkaufsliste.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="table-responsive mb-3">
        <form id="shoppinglist-form" method="post" class="d-flex gap-2 align-items-end">
            {% csrf_token %}
            <div style="flex: 2;">
                {{ form.name }}
            </div>
            <div style="flex: 1;">
                {{ form.amount }}
            </div>
            <div style="flex: 1;">
                {{ form.unit }}
            </div>
            <div style="flex: 1;">
                {{ form.product_group }}
            </div>
            <div>
                <button type="submit" class="btn btn-success">Artikel hinzufügen</button>
            </div>
        </form>
    </div>
    <div class="mt-2">
        <a href="{% url 'edit_trip' trip.pk %}" class="btn btn-secondary">Zurück</a>
    </div>

    <script>
        const form = document.getElementById("shoppinglist-form");

        // --- Hinzufügen ---
        form.addEventListener("submit", function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const csrftoken = this.querySelector('input[name="csrfmiddlewaretoken"]').value;

            fetch("{% url 'add_shoppinglist_item' trip.pk %}", {
                method: "POST",
                body: formData,
                headers: {"X-CSRFToken": csrftoken}
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const noItemsRow = document.getElementById("no-items-row");
                        if (noItemsRow) noItemsRow.remove();

                        const tbody = document.querySelector("#shoppinglist-table tbody");
                        tbody.insertAdjacentHTML("beforeend", `
                <tr id="item-${data.item.id}">
                    <td>${data.item.name}</td>
                    <td><input type="number" class="form-control form-control-sm inline-edit"
                               data-id="${data.item.id}" data-field="amount"
                               value="${data.item.amount}"></td>
                    <td><input type="text" class="form-control form-control-sm inline-edit"
                               data-id="${data.item.id}" data-field="unit"
                               value="${data.item.unit}"></td>

                    <td>
        <select class="form-select form-select-sm inline-edit"
        data-id="${data.item.id}"
        data-field="product_group">
    <option value="" selected>---------</option>
    {% for value, label in shoppinglist.model.GROUPS %}
        <option value="{{ value }}">{{ label }}</option>
    {% endfor %}
</select>
    </td>
                    <td class="text-end">
                        <button class="btn btn-success btn-sm delete-item"
                                data-id="${data.item.id}"
                                data-url="${data.item.delete_url}">✔</button>
                    </td>
                </tr>
            `);

                        attachDeleteHandlers();
                        attachInlineEditHandlers();
                        form.reset();
                    } else {
                        alert("Fehler: " + JSON.stringify(data.error));
                    }
                });
        });

        // --- Löschen ---
        function attachDeleteHandlers() {
            document.querySelectorAll('.delete-item').forEach(btn => {
                btn.onclick = function (e) {
                    e.preventDefault();
                    const itemId = this.dataset.id;
                    const url = this.dataset.url;
                    const csrftoken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;

                    fetch(url, {method: 'POST', headers: {'X-CSRFToken': csrftoken}})
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                document.getElementById(`item-${itemId}`).remove();
                                if (document.querySelectorAll('#shoppinglist-table tbody tr').length === 0) {
                                    const tbody = document.querySelector('#shoppinglist-table tbody');
                                    tbody.innerHTML = '<tr id="no-items-row"><td colspan="4" class="text-center text-muted">Keine Artikel in der Einkaufsliste.</td></tr>';
                                }
                                if (data.message) {
                                    const alert = document.createElement("div");
                                    alert.className = "alert alert-success mt-2";
                                    alert.innerText = data.message;

                                    document.querySelector("#messages").appendChild(alert);

                                    // Auto entfernen nach 3 Sekunden
                                    setTimeout(() => alert.remove(), 5000);
                                }
                            }
                        });
                }
            });
        }

        // --- Inline-Änderungen ---
        function attachInlineEditHandlers() {
            document.querySelectorAll('.inline-edit').forEach(input => {
                input.onchange = function () {
                    const itemId = this.dataset.id;
                    const field = this.dataset.field;
                    const value = this.value;
                    const csrftoken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;

                    fetch("{% url 'update_shoppinglist_item' %}", {
                        method: "POST",
                        headers: {"Content-Type": "application/json", "X-CSRFToken": csrftoken},
                        body: JSON.stringify({id: itemId, field: field, value: value})
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (!data.success) {
                                this.classList.add("is-invalid");
                            } else {
                                this.classList.remove("is-invalid");
                            }
                        });
                }
            });
        }

        attachDeleteHandlers();
        attachInlineEditHandlers();
    </script>
    <style>
        #shoppinglist-form input {
            width: 100%;
            min-width: 120px;
        }

        #shoppinglist-form select {
            min-width: 120px;
        }

        #shoppinglist-table td,
        #shoppinglist-table th {
            white-space: nowrap; /* verhindert Zeilenumbruch */
        }

        #shoppinglist-table input.form-control-sm,
        #shoppinglist-table select.form-select-sm {
            min-width: 75px; /* Mindestbreite */
        }

        #shoppinglist-table {
            table-layout: auto; /* flexible Spaltenbreite je nach Inhalt */
        }
    </style>
{% endblock %}

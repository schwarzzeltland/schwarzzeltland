{% extends "base.html" %}
{% load bootstrap5 %}

{% block content %}
    <div id="messages"></div>

    <!-- Such- und Filterbereich als Input-Group -->
    <form method="get" action="" class="mb-3">
        <div class="input-group">
            <!-- Textfeld Suche -->
            <input type="text" class="form-control" name="search"
                   value="{{ search_query|default:'' }}" placeholder="Suchen nach Artikel">

            <!-- Dropdown Warengruppe -->
            <select class="form-select" name="product_group">
                <option value="">Alle Warengruppen</option>
                {% for value, label in product_groups %}
                    <option value="{{ value }}"
                            {% if value|stringformat:"s" == selected_product_group %}selected{% endif %}>
                        {{ label }}
                    </option>
                {% endfor %}
            </select>

            <!-- Button -->
            <button class="btn btn-outline-secondary" type="submit">Suchen</button>
        </div>
    </form>


    <!-- Tabelle -->
    <div class="table-responsive mb-3">
        <table class="table table-hover align-middle" id="shoppinglist-table">
            <thead class="table-light">
            <tr>
                <th>Artikel</th>
                <th style="width: 120px;">Menge</th>
                <th style="width: 120px;">Einheit</th>
                <th style="width: 150px;">Warengruppe</th>
                <th class="text-end" style="width: 50px;"></th>
            </tr>
            </thead>
            <tbody>
            {% for item in shoppinglist %}
                <tr id="item-{{ item.pk }}">
                    <td class="fw-semibold">{{ item.name }}</td>
                    <td>
                        <input type="number" step="0.01" class="form-control form-control-sm inline-edit"
                               data-id="{{ item.pk }}" data-field="amount"
                               value="{{ item.amount_str }}">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm inline-edit"
                               data-id="{{ item.pk }}" data-field="unit"
                               value="{{ item.unit }}">
                    </td>
                    <td>
                        <select class="form-select form-select-sm inline-edit"
                                data-id="{{ item.pk }}" data-field="product_group">
                            <option value="">---------</option>
                            {% for value, label in item.GROUPS %}
                                <option value="{{ value }}"
                                        {% if item.product_group == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td class="text-end">
                        <button class="btn btn-success btn-sm delete-item"
                                data-id="{{ item.pk }}"
                                data-url="{% url 'delete_shoppinglist_item' item.pk %}">✔
                        </button>
                    </td>
                </tr>
            {% empty %}
                <tr id="no-items-row">
                    <td colspan="5" class="text-center text-muted">Keine Artikel in der Einkaufsliste.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Formular zum Hinzufügen -->
    <div class="card p-3 mb-3">
        <form id="shoppinglist-form" method="post" class="row g-2 align-items-end">
            {% csrf_token %}
            <div class="col-md-4 position-relative">
                {{ form.name }}

                <ul id="material-suggestions"
                    class="list-group position-absolute w-100"
                    style="z-index: 1000;">
                </ul>
            </div>
            <script>
                const materialInput = document.getElementById("material-input");
                const suggestionsList = document.getElementById("material-suggestions");

                let selectingSuggestion = false;

                // Funktion zum Laden der Vorschläge
                function loadSuggestions(query = "") {
                    fetch(`/events/trip/shoppinglist/autocomplete/?q=${encodeURIComponent(query)}`)
                        .then(res => res.json())
                        .then(data => {
                            suggestionsList.innerHTML = "";

                            data.forEach(name => {
                                const li = document.createElement("li");
                                li.className = "list-group-item list-group-item-action";
                                li.textContent = name;

                                li.addEventListener("click", () => {
                                    materialInput.value = name;
                                    suggestionsList.innerHTML = "";
                                });

                                suggestionsList.appendChild(li);
                            });
                        });
                }

                // 1️⃣ Vorschläge beim Fokus anzeigen
                materialInput.addEventListener("focus", function () {
                    loadSuggestions(""); // leeres Query → zeigt erste Materialien
                });

                // 2️⃣ Vorschläge beim Tippen filtern
                materialInput.addEventListener("input", function () {
                    const val = materialInput.value.trim();
                    loadSuggestions(val);
                });

                // 3️⃣ Dropdown schließen, wenn außerhalb geklickt wird
                document.addEventListener("click", function (e) {
                    if (!materialInput.contains(e.target) &&
                        !suggestionsList.contains(e.target)) {
                        suggestionsList.innerHTML = "";
                    }
                });
            </script>

            <div class="col-md-2">
                {{ form.amount }}
            </div>
            <div class="col-md-2">
                {{ form.unit }}
            </div>
            <div class="col-md-2">
                {{ form.product_group }}
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-success w-100">Artikel hinzufügen</button>
            </div>
        </form>
    </div>

    <a href="{% url 'edit_trip' trip.pk %}" class="btn btn-secondary">Zurück</a>

    <!-- Options für JS vorbereiten -->
    <script>
        const productGroupOptions = `
    <option value="">---------</option>
    {% for value, label in shoppinglist.model.GROUPS %}
        <option value="{{ value }}">{{ label }}</option>
    {% endfor %}
`;
    </script>

    <!-- Inline-Edit & Delete JS -->
    <script>
        const form = document.getElementById("shoppinglist-form");

        // Hinzufügen
        form.addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const csrftoken = this.querySelector('input[name="csrfmiddlewaretoken"]').value;

            fetch("{% url 'add_shoppinglist_item' trip.pk %}", {
                method: "POST",
                body: formData,
                headers: {"X-CSRFToken": csrftoken}
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const noItemsRow = document.getElementById("no-items-row");
                        if (noItemsRow) noItemsRow.remove();

                        const tbody = document.querySelector("#shoppinglist-table tbody");
                        tbody.insertAdjacentHTML("beforeend", `
<tr id="item-${data.item.id}">
    <td class="fw-semibold">${data.item.name}</td>
    <td><input type="number" class="form-control form-control-sm inline-edit"
               data-id="${data.item.id}" data-field="amount"
               value="${data.item.amount}"></td>
    <td><input type="text" class="form-control form-control-sm inline-edit"
               data-id="${data.item.id}" data-field="unit"
               value="${data.item.unit}"></td>
    <td>
        <select class="form-select form-select-sm inline-edit"
                data-id="${data.item.id}" data-field="product_group">
            ${productGroupOptions}
        </select>
    </td>
    <td class="text-end">
        <button class="btn btn-success btn-sm delete-item"
                data-id="${data.item.id}"
                data-url="${data.item.delete_url}">✔</button>
    </td>
</tr>
            `);

// Jetzt die richtige Kategorie auswählen:
                        const newRowSelect = document.querySelector(`#item-${data.item.id} select`);
                        if (newRowSelect) {
                            newRowSelect.value = data.item.product_group; // Setzt die richtige Auswahl
                        }

                        attachDeleteHandlers();
                        attachInlineEditHandlers();
                        form.reset();
                    } else {
                        alert("Fehler: " + JSON.stringify(data.error));
                    }
                });
        });

        // Delete & Inline-Edit bleiben unverändert
        function attachDeleteHandlers() {
            document.querySelectorAll('.delete-item').forEach(btn => {
                btn.onclick = function (e) {
                    e.preventDefault();
                    const itemId = this.dataset.id;
                    const url = this.dataset.url;
                    const csrftoken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;

                    fetch(url, {method: 'POST', headers: {'X-CSRFToken': csrftoken}})
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                document.getElementById(`item-${itemId}`).remove();
                                if (document.querySelectorAll('#shoppinglist-table tbody tr').length === 0) {
                                    const tbody = document.querySelector('#shoppinglist-table tbody');
                                    tbody.innerHTML = '<tr id="no-items-row"><td colspan="5" class="text-center text-muted">Keine Artikel in der Einkaufsliste.</td></tr>';
                                }
                                if (data.message) {
                                    const alert = document.createElement("div");
                                    alert.className = "alert alert-success mt-2";
                                    alert.innerText = data.message;
                                    document.querySelector("#messages").appendChild(alert);
                                    setTimeout(() => alert.remove(), 5000);
                                }
                            }
                        });
                }
            });
        }

        function attachInlineEditHandlers() {
            document.querySelectorAll('.inline-edit').forEach(input => {
                input.onchange = function () {
                    const itemId = this.dataset.id;
                    const field = this.dataset.field;
                    const value = this.value;
                    const csrftoken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;

                    fetch("{% url 'update_shoppinglist_item' %}", {
                        method: "POST",
                        headers: {"Content-Type": "application/json", "X-CSRFToken": csrftoken},
                        body: JSON.stringify({id: itemId, field: field, value: value})
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (!data.success) {
                                this.classList.add("is-invalid");
                            } else {
                                this.classList.remove("is-invalid");
                            }
                        });
                }
            });
        }

        attachDeleteHandlers();
        attachInlineEditHandlers();
    </script>

    <!-- CSS -->
    <style>
        #shoppinglist-table input.form-control-sm,
        #shoppinglist-table select.form-select-sm {
            min-width: 120px;
            width: 100%;
            box-sizing: border-box;
        }

        #shoppinglist-table {
            table-layout: auto;
            width: 100%;
        }

        #shoppinglist-table td,
        #shoppinglist-table th {
            white-space: nowrap;
        }

        #shoppinglist-form .form-control,
        #shoppinglist-form .form-select {
            min-width: 120px;
        }
        #material-suggestions {
        max-height: 100px;      /* maximale Höhe */
        overflow-y: auto;       /* vertikaler Scrollbalken bei Überlauf */
        z-index: 1000;
        position: absolute;
        width: 100%;
    }
    </style>
{% endblock %}

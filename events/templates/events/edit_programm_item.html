{% extends "base.html" %}
{% block content %}
    <div class="container mt-4">
        <form method="post">
            {% csrf_token %}
            <div class="mb-3">
                {{ form.name.label_tag }} {{ form.name }}
            </div>
            <div class="mb-3">
                {{ form.short_description.label_tag }} {{ form.short_description }}
            </div>
            <div class="mb-3">
                {{ form.description.label_tag }} {{ form.description }}
            </div>
            <div class="mb-3">
                {{ form.type.label_tag }} {{ form.type }}
            </div>
            <div class="mb-3" id="recipe-wrapper" style="display: none;">
                {{ form.recipe.label_tag }}
                {{ form.recipe }}
                    <a id="recipe-link"
                       data-next="{{ request.get_full_path|urlencode }}"
                       href="#"
                       class="btn btn-secondary mt-2"
                       style="display:none;">
                        Rezept für die Teilnehmeranzahl anzeigen
                    </a>
                {% if item.trip.owner.pro1 %}
                    <!-- Zutaten übernehmen -->
                        <a id="recipe-add-ingredients" href="{% url 'add_recipe_to_shoppinglist' item.pk %}?persons={{ item.trip.total_persons }}&next={{ request.get_full_path|urlencode }}"
                           class="btn btn-outline-success mt-2">
                            Zutaten zur Einkaufsliste
                        </a>
                {% endif %}
            </div>

            <div class="mb-3 form-check">
                {{ form.visible_for_members }}
                <label class="form-check-label">
                    {{ form.visible_for_members.label }}
                </label>
            </div>
            <div class="row mb-3">
                <div class="col">
                    {{ form.start_time.label_tag }} {{ form.start_time }}
                    {{ form.start_time.errors }}
                </div>
                <div class="col">
                    {{ form.end_time.label_tag }} {{ form.end_time }}
                    {{ form.end_time.errors }}
                </div>
            </div>
            <hr>

            <div class="mt-2">
                <button type="submit" name="save" class="btn btn-success">Änderungen speichern</button>
                <button type="submit" name="delete" class="btn btn-danger">Löschen</button>
            </div>
            <div class="mt-2">
                <a href="{% url 'programm' item.trip.pk %}" class="btn btn-secondary">Abbrechen</a>
            </div>
        </form>
    </div>
    <div class="mb-3" id="recipe-wrapper" style="display: none;">
        {{ form.recipe.label_tag }}
        {{ form.recipe }}

        <a id="recipe-link"
           href="#"
           class="btn btn-secondary mt-2"
           style="display:none;"
           target="_blank">
            Rezept für die Teilnehmeranzahl anzeigen
        </a>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const typeSelect = document.getElementById("id_type");
            const recipeWrapper = document.getElementById("recipe-wrapper");
            const recipeSelect = document.getElementById("id_recipe");
            const recipeLink = document.getElementById("recipe-link");
            const recipeaddingredients = document.getElementById("recipe-add-ingredients");

            function updateRecipeVisibility() {
                const isMeal = typeSelect.value === "0"; // TYPE_MEAL

                recipeWrapper.style.display = isMeal ? "block" : "none";

                if (!isMeal) {
                    recipeLink.style.display = "none";
                    recipeLink.href = "#";
                    recipeaddingredients.style.display = "none";
                }
            }

            function updateRecipeLink() {
                const recipeId = recipeSelect.value;
                const nextUrl = recipeLink.dataset.next;

                if (recipeId) {
                    recipeLink.href =
                        `/knowledgebase/recipes/show_my_recipe/${recipeId}/?next=${nextUrl}&persons={{ item.trip.total_persons }}`;
                    recipeLink.style.display = "inline-block";
                    recipeaddingredients.style.display = "inline-block";
                } else {
                    recipeLink.style.display = "none";
                    recipeLink.href = "#";
                    recipeaddingredients.style.display = "none";
                }
            }

            typeSelect.addEventListener("change", updateRecipeVisibility);
            recipeSelect.addEventListener("change", updateRecipeLink);

            // Initialer Zustand (Edit-View!)
            updateRecipeVisibility();
            updateRecipeLink();
        });
    </script>



{% endblock %}

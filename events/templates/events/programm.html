{% extends "base.html" %}
{% load bootstrap5 %}


{% block content %}
    <div id="messages"></div>
    <!-- Such- und Filterbereich -->
    <form method="get" class="mb-3">
        <div class="input-group">
            <input type="text" class="form-control" name="search"
                   value="{{ search_query|default:'' }}" placeholder="Suche nach Programmpunkt">

            <select id="type-select" name="type" multiple class="form-select">
                {% for t in types %}
                    <option value="{{ t.id }}" {% if t.id in selected_type_list %}selected{% endif %}>
                        {{ t.text }}
                    </option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-outline-secondary">Suchen</button>
        </div>
    </form>


    <!-- Select2 CSS & JS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        $(document).ready(function () {
            $('#type-select').select2({
                placeholder: "W√§hle Typen aus",
                allowClear: true,
                tags: false,
                width: 'resolve'
            });
        });
    </script>


    <div id="programm-wrapper"
         style="display: flex; overflow-x: auto; overflow-y: hidden; gap: 20px; max-width: 1200px; margin: auto;">
        {% for day, items in grouped_by_day %}
            <div class="day-column" style="flex-shrink: 0; width: {{ day_width }}px; border: 1px solid #ccc;">
                <h3 style="text-align:center; margin-bottom:10px;">{{ day|date:"D, d.m." }}</h3>
                <div style="position: relative; height: {{ container_height }}px;">
                    <!-- Stundenlinien -->
                    {% for hour, position in hours %}
                        <div class="hour-line" style="top: {{ position }}px;">
                            {{ hour }}:00
                        </div>
                    {% endfor %}
                    <!-- Programmkarten -->
                    {% for item in items %}
                        {% if is_event_manager %}
                            <a href="{% url 'edit_programm_item' item.pk %}"
                               style="text-decoration:none; color:inherit;">
                        {% elif item.visible_for_members %}
                            <a href="{% url 'show_programm_item' item.pk %}"
                               style="text-decoration:none; color:inherit;">
                        {% endif %}
                    <div class="card {{ item.type_class }}  {% if not is_event_manager and not item.visible_for_members %}
                            restricted
                        {% endif %}"
                         style="top: {{ item.offset|floatformat:0 }}px;
                                 height: {{ item.duration|floatformat:0 }}px;
                                 left: {{ item.left|floatformat:0 }}px;
                                 width: {{ item.width|floatformat:0 }}px;">
                        <strong>{{ item.name }}</strong><br>
                        <small>{{ item.get_type_display }}</small><br>
                        <small>{{ item.start_time|date:"H:i" }} - {{ item.end_time|date:"H:i" }}</small><br>
                        <p>{{ item.short_description }}</p>
                    </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>
    {% if is_event_manager %}
        <div class="mt-2">
            <a href="{% url 'add_programm_item' trip.id %}" class="btn btn-success">Programmpunkt hinzuf√ºgen</a>
            {% if is_pro_1 %}
                <a href="{% url 'add_accumulated_ingredients' trip.pk %}" class="btn btn-primary">Rezept-Zutaten b√ºndeln
                    & zur Einkaufsliste hinzuf√ºgen</a>
            {% endif %}
            <a href="{% url 'print_programm' trip.pk %}?search={{ search_query }}&type={{ selected_type_list|join:',' }}"
               target="_blank"
               class="btn btn-outline-primary">
                üñ® Programm drucken
            </a>

        </div>
        <div class="mt-2">
            <a href="{% url 'edit_trip' trip.pk %}" class="btn btn-secondary">Zur√ºck</a>
        </div>
    {% else %}
        <div class="mt-2">
            <a href="{% url 'show_trip' trip.pk %}" class="btn btn-secondary">Zur√ºck</a>
        </div>
    {% endif %}
    <style>
        .day-column {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            position: relative;
        }

        .hour-line {
            position: absolute;
            width: 100%;
            border-top: 1px dashed #ddd;
            font-size: 10px;
            color: #666;
            z-index: 0;
        }

        .card {
            position: absolute;
            z-index: 1;
            color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            padding: 10px;
            display: block;
        }

        .type-meal {
            background-color: #4caf50;
        }

        .type-workshop {
            background-color: #2196f3;
        }

        .type-service {
            background-color: #ff9800;
        }

        .type-meal-service {
            background-color: #29602b;
        }

        .type-evening {
            background-color: #673ab7;
        }

        .type-other {
            background-color: #607d8b;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            cursor: pointer;
        }

        .card {
            position: absolute;
            box-sizing: border-box;
        }

        .card.restricted {
            background-color: #999 !important;
            color: transparent;
            text-shadow: 0 0 6px rgba(0, 0, 0, 0.6);
            cursor: not-allowed;
        }

        .card.restricted * {
            visibility: hidden;
        }

        .card.restricted::after {
            content: "Nicht sichtbar";
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            font-size: 0.9rem;
            visibility: visible;
        }

        @page {
            size: A4 portrait;
            margin: 15mm;
        }

        @media print {

            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            html, body {
                height: auto !important;
                overflow: visible !important;
            }

            body * {
                visibility: hidden;
            }

            #programm-wrapper,
            #programm-wrapper * {
                visibility: visible;
            }

            #programm-wrapper {
                position: static !important;
                overflow: visible !important;

                display: block !important;
                white-space: nowrap;

                zoom: 0.50; /* <- DAS ist der Schl√ºssel */
            }

            .day-column {
                display: inline-block;
                vertical-align: top;
                page-break-inside: avoid;
            }
        }

        /* Gemeinsame H√∂he f√ºr Input + Select2 */
        .input-group .form-control,
        .input-group .select2-container--default .select2-selection--multiple {
            border-radius: 0.0rem; /* leicht abgerundet, wie Bootstrap */
            line-height: 1.0;
            padding: 0.6rem 0.5rem;
        }


    </style>
{% endblock %}
